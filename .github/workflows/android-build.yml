name: 🔍 Android Build Diagnostic

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      CAPACITOR_TELEMETRY: false
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ☕ Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 📱 Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0

    - name: 🔍 Environment Check
      run: |
        echo "=== Node.js Version ==="
        node --version
        npm --version
        echo "=== Java Version ==="
        java -version
        echo "=== Android SDK ==="
        echo $ANDROID_HOME
        ls -la $ANDROID_HOME/platforms/ || echo "No platforms found"
        ls -la $ANDROID_HOME/build-tools/ || echo "No build-tools found"

    - name: 📦 Install dependencies
      run: |
        echo "Installing npm dependencies..."
        npm ci
        echo "Dependencies installed successfully"

    - name: 🏗️ Build web app
      run: |
        echo "Building web application..."
        npm run build
        echo "Web build completed"
        ls -la dist/

    - name: 🔄 Capacitor Setup
      run: |
        echo "Disabling telemetry..."
        npx cap telemetry off
        echo "Syncing Capacitor..."
        npx cap sync android
        echo "Capacitor sync completed"

    - name: 🔍 Android Project Check
      run: |
        echo "=== Android project structure ==="
        ls -la android/
        echo "=== Gradle wrapper ==="
        ls -la android/gradlew
        chmod +x android/gradlew
        echo "=== Gradle version ==="
        cd android && ./gradlew --version

    - name: 📱 Build Android APK (Debug)
      working-directory: android
      run: |
        echo "Starting Android build..."
        ./gradlew assembleDebug --stacktrace --info